{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Turnover - Dragon Ricemill</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    html { scroll-behavior: smooth; }
    .dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    .filter-input {
      @apply border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition duration-200;
    }

    .stats-card {
      @apply bg-white rounded-xl p-6 shadow-sm border border-gray-100 transition-transform duration-200 hover:transform hover:scale-102;
    }

    .table-container {
      @apply bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden;
    }

    .table-header {
      @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
    }

    .table-cell {
      @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900;
    }

    .export-btn {
      @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-colors duration-200;
    }

    .filter-btn {
      @apply inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200;
    }

    .sorted-asc::after {
      content: ' â†‘';
      color: #4B5563;
    }
    
    .sorted-desc::after {
      content: ' â†“';
      color: #4B5563;
    }
    
    #turnover-table th:hover {
      background-color: #F3F4F6;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen font-sans leading-relaxed overflow-x-hidden">

<!-- Toggle Sidebar Button -->
<button id="sidebarToggle" class="fixed top-4 right-4 z-50 bg-white p-2 rounded-lg shadow-lg hover:bg-gray-100 lg:hidden">
  <i class="fas fa-bars text-gray-600"></i>
</button>

<header id="sidebar" class="fixed top-0 right-0 h-screen w-56 bg-white shadow-lg flex flex-col z-40 border-l border-gray-200 transition-transform duration-300 ease-in-out lg:translate-x-0">
  <div class="h-14 flex items-center justify-center border-b border-gray-200">
    <a href="#" class="flex items-center space-x-2 select-none text-gray-900 font-bold text-lg tracking-wide">
      <span class="text-yellow-500 text-2xl">ðŸŒ¾</span>
      <span>Dragon Ricemill</span>
    </a>
  </div>

  <nav class="flex-1 flex flex-col py-1 pr-1 overflow-y-auto scrollbar-hide">
    <!-- Main Navigation -->
    <div class="px-2 py-1">
      <span class="block text-1 text-gray-500 font-semibold mb-3">Welcome, {{ request.session.user_name }}!</span>
      <a href="{% url 'dashboard' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 font-semibold hover:text-yellow-600 transition">
        <i class="fas fa-home w-4 text-yellow-500"></i><span>Home</span>
      </a>
      <a href="{% url 'profile' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition text-gray-900">
        <i class="fas fa-user-circle w-4 text-yellow-500"></i><span>Profile</span>
      </a>
    </div>

    {% if request.session.user_role == 'admin' %}
    <!-- User Management Section -->
    <div class="mb-2 px-2">
      <p class="uppercase text-xs font-semibold text-gray-400 mb-1">User Management</p>
      <!-- Employee Management -->
      <a href="{% url 'add_user' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition">
        <i class="fas fa-user-plus w-4 text-yellow-500"></i><span>Add User</span>
      </a>
      <a href="{% url 'edituser' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition mt-1">
        <i class="fas fa-user-edit w-4 text-yellow-500"></i><span>Edit User</span>
      </a>
      <a href="{% url 'logs' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition mt-1">
        <i class="fas fa-file-alt w-4 text-yellow-500"></i><span>User Logs</span>
      </a>

      <!-- Customer Management -->
      <p class="uppercase text-xs font-semibold text-gray-400 mb-1 mt-4">Customer Management</p>
      <a href="{% url 'user_account' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition">
        <i class="fas fa-users w-4 text-yellow-500"></i><span>Customers</span>
      </a>
      <a href="{% url 'add_customer' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition mt-1">
        <i class="fas fa-user-plus w-4 text-yellow-500"></i><span>Add Customer</span>
      </a>
      <a href="{% url 'customer_ledger_create' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition mt-1">
        <i class="fas fa-book w-4 text-yellow-500"></i><span>Create Customer Ledger</span>
      </a>
    </div>
    {% endif %}

    <!-- Orders & Transactions -->
    <div class="mb-2 px-2">
      <p class="uppercase text-xs font-semibold text-gray-400 mb-1">Orders & Transactions</p>
      {% if request.session.user_role == 'admin' or request.session.user_role == 'cashier' %}
      <a href="{% url 'new_sale' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition">
        <i class="fas fa-cart-plus w-4 text-yellow-500"></i><span>New Order</span>
      </a>
      {% endif %}
      <a href="{% url 'allorder_history' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition {% if request.session.user_role == 'admin' or request.session.user_role == 'cashier' %}mt-1{% endif %}">
        <i class="fas fa-history w-4 text-yellow-500"></i><span>All Orders History</span>
      </a>
      <a href="{% url 'payment_confirmation' 0 %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition mt-1">
        <i class="fas fa-money-check w-4 text-yellow-500"></i><span>Payment Confirmation</span>
      </a>
      <a href="{% url 'delivery_confirmation' 0 %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition mt-1">
        <i class="fas fa-truck w-4 text-yellow-500"></i><span>Delivery Confirmation</span>
      </a>
    </div>

    {% if request.session.user_role == 'admin' or request.session.user_role == 'employee' %}
    <!-- Inventory Management -->
    <div class="mb-2 px-2">
      <p class="uppercase text-xs font-semibold text-gray-400 mb-1">Inventory</p>
      <a href="{% url 'addstock' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition">
        <i class="fas fa-boxes w-4 text-yellow-500"></i><span>Manage Inventory</span>
      </a>
      <a href="{% url 'viewstocklevel' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition mt-1">
        <i class="fas fa-layer-group w-4 text-yellow-500"></i><span>View Stock Levels</span>
      </a>
    </div>
    {% endif %}

    {% if request.session.user_role == 'admin' or request.session.user_role == 'cashier' %}
    <!-- Sales Management -->
    <div class="mb-2 px-2">
      <p class="uppercase text-xs font-semibold text-gray-400 mb-1">Sales</p>
      <a href="{% url 'invoice' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition">
        <i class="fas fa-file-invoice w-4 text-yellow-500"></i><span>Create Invoice</span>
      </a>
      <a href="{% url 'view_sales_report' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-yellow-50 hover:text-yellow-600 transition mt-1">
        <i class="fas fa-chart-line w-4 text-yellow-500"></i><span>Sales Report</span>
      </a>
      <a href="{% url 'inventory_turnover' %}" class="flex items-center space-x-2 px-2 py-1 rounded text-sm bg-yellow-50 text-yellow-600 transition mt-1">
        <i class="fas fa-sync-alt w-4 text-yellow-500"></i><span>Inventory Turnover</span>
      </a>
    </div>
    {% endif %}

    <!-- Logout -->
    <div class="border-t border-gray-200 mt-auto px-2 py-4">
      <a href="{% url 'logout' %}" onclick="return confirm('Logout?');" class="flex items-center space-x-2 px-2 py-1 rounded text-sm hover:bg-red-100 hover:text-red-600 transition font-semibold text-red-500 mt-2">
        <i class="fas fa-sign-out-alt w-4"></i><span>Logout</span>
      </a>
    </div>
  </nav>
</header>

 <!-- Push content so it's not behind the sidebar -->
<div id="mainContent" class="lg:mr-56 min-h-screen bg-gray-50 transition-all duration-300">
  <main class="max-w-7xl mx-auto p-8">
    <div class="mb-8">
      <h2 class="text-3xl font-bold text-gray-900">Monthly Inventory Turnover</h2>
      <p class="mt-1 text-sm text-gray-500">Track and analyze your monthly inventory efficiency</p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
      {% if error_message %}
        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-exclamation-circle text-red-400"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm text-red-700">{{ error_message }}</p>
            </div>
          </div>
        </div>
      {% endif %}

      <form id="filterForm" method="GET" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Rice Type -->
        <div>
          <label for="rice_type" class="block text-sm font-medium text-gray-700 mb-1">Rice Type</label>
          <div class="relative">
            <select name="rice_type" id="rice_type" class="filter-input w-full pl-10 pr-4 py-2 appearance-none">
              <option value="">All Types</option>
              {% for rice in rice_types %}
                <option value="{{ rice.riceID }}" {% if selected_rice_type == rice.riceID|stringformat:"s" %}selected{% endif %}>
                  {{ rice.rice_type }}
                </option>
              {% endfor %}
            </select>
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-box text-gray-400"></i>
            </div>
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              <i class="fas fa-chevron-down text-gray-400"></i>
            </div>
          </div>
        </div>

        <!-- Start Month -->
        <div>
          <label for="start_month" class="block text-sm font-medium text-gray-700 mb-1">Start Month</label>
          <div class="relative">
            <input type="month" name="start_month" id="start_month" value="{{ start_date|date:'Y-m' }}" class="filter-input w-full pl-10 pr-4 py-2" required>
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-calendar text-gray-400"></i>
            </div>
          </div>
        </div>

        <!-- End Month -->
        <div>
          <label for="end_month" class="block text-sm font-medium text-gray-700 mb-1">End Month</label>
          <div class="relative">
            <input type="month" name="end_month" id="end_month" value="{{ end_date|date:'Y-m' }}" class="filter-input w-full pl-10 pr-4 py-2" required>
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-calendar text-gray-400"></i>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex items-end space-x-4">
          <button type="submit" class="filter-btn flex-1">
            <i class="fas fa-filter mr-2"></i>Apply Filters
          </button>
          <button type="button" id="currentMonthBtn" class="export-btn">
            <i class="fas fa-clock mr-2"></i>Current Month
          </button>
        </div>
      </form>
    </div>

    <!-- Summary Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- Total Sales -->
      <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-blue-100 rounded-md p-3">
            <i class="fas fa-shopping-cart text-blue-600"></i>
          </div>
          <div class="ml-5">
            <h3 class="text-sm font-medium text-gray-500">Total Sales</h3>
            <p class="text-2xl font-semibold text-gray-900">â‚±{{ summary_stats.total_sales|default:"0"|floatformat:2|intcomma }}</p>
          </div>
        </div>
      </div>

      <!-- Total Quantity -->
      <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-green-100 rounded-md p-3">
            <i class="fas fa-boxes text-green-600"></i>
          </div>
          <div class="ml-5">
            <h3 class="text-sm font-medium text-gray-500">Total Quantity Sold</h3>
            <p class="text-2xl font-semibold text-gray-900">{{ summary_stats.total_quantity|default:"0"|intcomma }} sacks</p>
          </div>
        </div>
      </div>

      <!-- Avg Turnover -->
      <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
        <div class="flex items-center">
          <div class="flex-shrink-0 bg-yellow-100 rounded-md p-3">
            <i class="fas fa-sync-alt text-yellow-600"></i>
          </div>
          <div class="ml-5">
            <h3 class="text-sm font-medium text-gray-500">Average Turnover Ratio</h3>
            <p class="text-2xl font-semibold text-gray-900">{{ summary_stats.avg_turnover|default:"0" }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <div class="p-6 border-b border-gray-100">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Monthly Turnover Summary</h3>
            <p class="text-sm text-gray-500 mt-1">
              {% if start_date and end_date %}
                Showing data from {{ start_date|date:"F Y" }} to {{ end_date|date:"F Y" }}
              {% else %}
                Showing all months
              {% endif %}
            </p>
          </div>
          <button onclick="exportInventoryTurnoverToExcel()" class="export-btn">
            <i class="fas fa-download mr-2"></i>Export to Excel
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="turnover-table" class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th class="table-header cursor-pointer hover:bg-gray-100">
                <div class="flex items-center">
                  <span>Rice Type</span>
                  <i class="fas fa-sort ml-1 text-gray-400"></i>
                </div>
              </th>
              <th class="table-header text-right cursor-pointer hover:bg-gray-100">
                <div class="flex items-center justify-end">
                  <span>Beginning Stock</span>
                  <i class="fas fa-sort ml-1 text-gray-400"></i>
                </div>
              </th>
              <th class="table-header text-right cursor-pointer hover:bg-gray-100">
                <div class="flex items-center justify-end">
                  <span>Ending Stock</span>
                  <i class="fas fa-sort ml-1 text-gray-400"></i>
                </div>
              </th>
              <th class="table-header text-right cursor-pointer hover:bg-gray-100">
                <div class="flex items-center justify-end">
                  <span>Quantity Sold</span>
                  <i class="fas fa-sort ml-1 text-gray-400"></i>
                </div>
              </th>
              <th class="table-header text-right cursor-pointer hover:bg-gray-100">
                <div class="flex items-center justify-end">
                  <span>Cost of Goods Sold</span>
                  <i class="fas fa-sort ml-1 text-gray-400"></i>
                </div>
              </th>
              <th class="table-header text-right cursor-pointer hover:bg-gray-100">
                <div class="flex items-center justify-end">
                  <span>Turnover Ratio</span>
                  <i class="fas fa-sort ml-1 text-gray-400"></i>
                </div>
              </th>
              <th class="table-header cursor-pointer hover:bg-gray-100 bg-yellow-50">
                <div class="flex items-center">
                  <i class="fas fa-calendar-alt text-yellow-600 mr-2"></i>
                  <span class="font-medium text-yellow-800">Month</span>
                  <i class="fas fa-sort ml-1 text-yellow-600"></i>
                </div>
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for item in turnover_data %}
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="table-cell font-medium">{{ item.rice_type }}</td>
                <td class="table-cell text-right">{{ item.beginning_stock|default:0|intcomma }}</td>
                <td class="table-cell text-right">{{ item.ending_stock|default:0|intcomma }}</td>
                <td class="table-cell text-right">{{ item.total_quantity|default:0|intcomma }}</td>
                <td class="table-cell text-right">â‚±{{ item.cogs|default:0|floatformat:2|intcomma }}</td>
                <td class="table-cell text-right font-medium">{{ item.inventory_turnover_ratio|default:0|floatformat:2 }}</td>
                <td class="table-cell">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                    {% if item.month|date:'Y-m' == current_month|date:'Y-m' %}
                      bg-yellow-100 text-yellow-800
                    {% else %}
                      bg-blue-100 text-blue-800
                    {% endif %}">
                    {{ item.month|date:"F Y" }}
                  </span>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center py-4 text-gray-500">No data available for selected filters.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>


<!-- Export Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Table functionality -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
  // Initialize form handling
  initializeFormHandling();
  
  // Initialize table functionality
  initializeTable();
  
  // Set current month by default if no dates are selected
  setDefaultMonth();
});

function setDefaultMonth() {
  const startMonth = document.getElementById('start_month');
  const endMonth = document.getElementById('end_month');
  
  if (!startMonth.value || !endMonth.value) {
    const today = new Date();
    const currentMonth = today.toISOString().slice(0, 7); // YYYY-MM format
    startMonth.value = currentMonth;
    endMonth.value = currentMonth;
  }
}

function initializeFormHandling() {
  const form = document.getElementById('filterForm');
  const startMonth = document.getElementById('start_month');
  const endMonth = document.getElementById('end_month');
  const currentMonthBtn = document.getElementById('currentMonthBtn');

  // Handle current month button click
  currentMonthBtn.addEventListener('click', function(e) {
    e.preventDefault();
    const today = new Date();
    const currentMonth = today.toISOString().slice(0, 7); // YYYY-MM format
    startMonth.value = currentMonth;
    endMonth.value = currentMonth;
    form.submit();
  });

  // Validate date range before submit
  form.addEventListener('submit', function(e) {
    if (!startMonth.value || !endMonth.value) {
      e.preventDefault();
      alert('Please select both start and end months');
      return;
    }

    if (startMonth.value > endMonth.value) {
      e.preventDefault();
      alert('Start month cannot be later than end month');
      return;
    }
  });

  // Update end month min value when start month changes
  startMonth.addEventListener('change', function() {
    endMonth.min = this.value;
    if (endMonth.value && endMonth.value < this.value) {
      endMonth.value = this.value;
    }
  });

  // Update start month max value when end month changes
  endMonth.addEventListener('change', function() {
    startMonth.max = this.value;
    if (startMonth.value && startMonth.value > this.value) {
      startMonth.value = this.value;
    }
  });
}

function initializeTable() {
  const table = document.getElementById('turnover-table');
  if (!table) return;

  // Add search functionality
  addTableSearch(table);
  
  // Add sorting functionality
  addTableSorting(table);
}

function addTableSearch(table) {
  // Create search input
  const searchContainer = document.createElement('div');
  searchContainer.className = 'mb-4 relative';
  searchContainer.innerHTML = `
    <div class="relative">
      <input type="text" 
             id="table-search" 
             class="filter-input w-full pl-10 pr-4 py-2" 
             placeholder="Search in table..."
             style="max-width: 300px;">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <i class="fas fa-search text-gray-400"></i>
      </div>
    </div>
  `;

  // Insert search before table
  table.parentNode.insertBefore(searchContainer, table);

  // Add search functionality
  const searchInput = document.getElementById('table-search');
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const tbody = table.querySelector('tbody');
    const rows = tbody.getElementsByTagName('tr');

    Array.from(rows).forEach(row => {
      // Skip if this is the "no data" row
      if (row.cells.length === 1 && row.cells[0].hasAttribute('colspan')) {
        return;
      }

      const text = Array.from(row.cells)
        .map(cell => cell.textContent.toLowerCase())
        .join(' ');

      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
}

function addTableSorting(table) {
  const headers = table.querySelectorAll('thead th');
  
  headers.forEach((header, index) => {
    // Add sort icons and styling
    const headerContent = header.innerHTML;
    header.innerHTML = `
      <div class="flex items-center ${header.classList.contains('text-right') ? 'justify-end' : ''}">
        <span>${headerContent}</span>
        <i class="fas fa-sort ml-1 text-gray-400"></i>
      </div>
    `;
    
    // Add click handler
    header.addEventListener('click', () => sortTable(table, index));
    header.style.cursor = 'pointer';
  });
}

function sortTable(table, columnIndex) {
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const header = table.querySelectorAll('th')[columnIndex];
  
  // Skip if this is the "no data" row
  if (rows.length === 1 && rows[0].cells[0].hasAttribute('colspan')) {
    return;
  }

  // Determine sort direction
  const currentDirection = header.getAttribute('data-sort') || 'asc';
  const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';

  // Update sort indicators
  table.querySelectorAll('th').forEach(th => {
    th.removeAttribute('data-sort');
    th.querySelector('.fas').className = 'fas fa-sort ml-1 text-gray-400';
  });
  header.setAttribute('data-sort', newDirection);
  header.querySelector('.fas').className = `fas fa-sort-${newDirection} ml-1 text-yellow-600`;

  // Sort rows
  rows.sort((rowA, rowB) => {
    let cellA = rowA.cells[columnIndex].textContent.trim();
    let cellB = rowB.cells[columnIndex].textContent.trim();

    // For month column, get the text inside the span
    if (columnIndex === 6) { // Month column
      cellA = rowA.cells[columnIndex].querySelector('span').textContent.trim();
      cellB = rowB.cells[columnIndex].querySelector('span').textContent.trim();
    }

    const valueA = parseCellValue(cellA);
    const valueB = parseCellValue(cellB);

    // Handle different types consistently
    if (valueA instanceof Date && valueB instanceof Date) {
      return newDirection === 'asc' ? valueA - valueB : valueB - valueA;
    }
    
    if (typeof valueA === 'number' && typeof valueB === 'number') {
      return newDirection === 'asc' ? valueA - valueB : valueB - valueA;
    }
    
    // Default string comparison
    return newDirection === 'asc' 
      ? String(valueA).localeCompare(String(valueB))
      : String(valueB).localeCompare(String(valueA));
  });

  // Reorder rows
  rows.forEach(row => tbody.appendChild(row));
}

function parseCellValue(value) {
  // Remove currency symbol and commas
  const cleanValue = value.replace(/[â‚±,]/g, '').trim();
  
  // Try to parse as number
  const number = parseFloat(cleanValue);
  if (!isNaN(number)) {
    return number;
  }
  
  // Try to parse as date (Month Year format)
  const monthMatch = value.match(/([A-Za-z]+)\s+(\d{4})/);
  if (monthMatch) {
    const monthName = monthMatch[1];
    const year = monthMatch[2];
    const monthIndex = new Date(`${monthName} 1, ${year}`).getMonth();
    return new Date(year, monthIndex, 1);
  }
  
  // Return as string if not number or date
  return value;
}

// Export to Excel functionality
function exportInventoryTurnoverToExcel() {
  const table = document.getElementById('turnover-table');
  if (!table) {
    alert('Table not found!');
    return;
  }

  try {
    // Create workbook
    const wb = XLSX.utils.book_new();
    
    // Get headers
    const headers = Array.from(table.querySelectorAll('thead th'))
      .map(th => th.textContent.trim());

    // Get data rows
    const rows = Array.from(table.querySelectorAll('tbody tr'))
      .filter(row => !row.querySelector('td[colspan]')) // Filter out "no data" row
      .map(row => Array.from(row.cells).map(cell => {
        let value = cell.textContent.trim();
        
        // Convert currency values to numbers
        if (value.startsWith('â‚±')) {
          value = parseFloat(value.replace('â‚±', '').replace(/,/g, ''));
        }
        // Convert other numeric values
        else if (value.includes(',') && !isNaN(value.replace(/,/g, ''))) {
          value = parseFloat(value.replace(/,/g, ''));
        }
        
        return value;
      }));

    // Combine headers and data
    const data = [headers, ...rows];

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);

    // Set column widths
    ws['!cols'] = headers.map(() => ({ wch: 15 }));

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Inventory Turnover');

    // Generate filename with current date
    const date = new Date().toISOString().split('T')[0];
    const filename = `Inventory_Turnover_Report_${date}.xlsx`;

    // Save file
    XLSX.writeFile(wb, filename);
  } catch (error) {
    console.error('Export error:', error);
    alert('An error occurred while exporting. Please try again.');
  }
}
</script>

</body>
</html>
